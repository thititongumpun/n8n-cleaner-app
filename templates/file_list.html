{% extends "base.html" %} {% block title %}{{ title }}{% endblock %} {% block
content %}
<div class="bg-white rounded-lg shadow-md p-6">
  <!-- Header -->
  <div class="mb-6">
    <h1 class="text-3xl font-bold text-gray-900 mb-2">{{ title }}</h1>
    {% if current_path %}
    <nav class="flex items-center space-x-2 text-sm text-gray-600">
      <a href="/" class="hover:text-blue-600 transition">Home</a>
      <span>/</span>
      <span class="text-gray-900 font-medium">{{ current_path }}</span>
    </nav>
    {% endif %}
  </div>

  <!-- Actions Bar -->
  <div class="mb-6 flex gap-4">
    <!-- Search Bar -->
    <div class="flex-1">
      <input
        type="text"
        id="searchInput"
        placeholder="Search files..."
        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition"
      />
    </div>

    <!-- Delete Selected Button -->
    <button
      id="deleteSelectedBtn"
      onclick="deleteSelected()"
      class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed"
      disabled
    >
      üóëÔ∏è Delete Selected
    </button>

    <!-- Download Selected Button -->
    <button
      id="downloadSelectedBtn"
      onclick="downloadSelected()"
      class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed"
      disabled
    >
      üì• Download Selected
    </button>
  </div>

  <!-- File List -->
  {% if items %}
  <form id="deleteForm" method="POST" action="/delete-multiple">
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left">
              <input
                type="checkbox"
                id="selectAll"
                class="w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500"
                onchange="toggleSelectAll(this)"
              />
            </th>
            <th
              class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
            >
              Name
            </th>
            <th
              class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
            >
              Type
            </th>
            <th
              class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
            >
              Size
            </th>
            <th
              class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
            >
              Actions
            </th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200" id="fileTableBody">
          {% for item in items %}
          <tr class="hover:bg-gray-50 transition file-row">
            <td class="px-6 py-4">
              <input
                type="checkbox"
                name="selected_files"
                value="{{ item.path }}"
                class="file-checkbox w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500"
                onchange="updateDeleteButton()"
              />
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="flex items-center">
                <span class="text-2xl mr-3">{{ item.type }}</span>
                <span class="text-sm font-medium text-gray-900 file-name"
                  >{{ item.name }}</span
                >
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              {% if item.is_dir %}
              <span
                class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800"
              >
                Folder
              </span>
              {% else %}
              <span
                class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800"
              >
                File
              </span>
              {% endif %}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
              {{ item.size }}
            </td>
            <td
              class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-3"
            >
              {% if item.is_dir %}
              <a
                href="/folder/{{ item.path }}"
                class="text-blue-600 hover:text-blue-900 transition"
              >
                Open
              </a>
              {% else %}
              <a
                href="/static/{{ item.path }}"
                target="_blank"
                class="text-green-600 hover:text-green-900 transition"
              >
                View
              </a>
              {% endif %}

              <!-- Delete Single Item -->
              <button
                type="button"
                onclick="deleteSingle('{{ item.path }}', '{{ item.name }}')"
                class="text-red-600 hover:text-red-900 transition"
              >
                Delete
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </form>
  {% else %}
  <div class="text-center py-12">
    <svg
      class="mx-auto h-12 w-12 text-gray-400"
      fill="none"
      viewBox="0 0 24 24"
      stroke="currentColor"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z"
      />
    </svg>
    <h3 class="mt-2 text-sm font-medium text-gray-900">No files found</h3>
    <p class="mt-1 text-sm text-gray-500">This directory is empty.</p>
  </div>
  {% endif %}
</div>

<!-- Delete Confirmation Modal -->
<div
  id="deleteModal"
  class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50"
>
  <div
    class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white"
  >
    <div class="mt-3 text-center">
      <div
        class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100"
      >
        <svg
          class="h-6 w-6 text-red-600"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
          />
        </svg>
      </div>
      <h3 class="text-lg leading-6 font-medium text-gray-900 mt-4">
        Confirm Delete
      </h3>
      <div class="mt-2 px-7 py-3">
        <p class="text-sm text-gray-500" id="deleteMessage"></p>
      </div>
      <div class="items-center px-4 py-3 flex gap-3">
        <button
          onclick="closeModal()"
          class="flex-1 px-4 py-2 bg-gray-200 text-gray-900 rounded-md hover:bg-gray-300 transition"
        >
          Cancel
        </button>
        <button
          id="confirmDeleteBtn"
          class="flex-1 px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition"
        >
          Delete
        </button>
      </div>
    </div>
  </div>
</div>

<!-- JavaScript -->
<script>
  // Search functionality
  const searchInput = document.getElementById("searchInput");
  const fileRows = document.querySelectorAll(".file-row");

  searchInput.addEventListener("input", (e) => {
    const searchTerm = e.target.value.toLowerCase();

    fileRows.forEach((row) => {
      const fileName = row
        .querySelector(".file-name")
        .textContent.toLowerCase();
      if (fileName.includes(searchTerm)) {
        row.style.display = "";
      } else {
        row.style.display = "none";
      }
    });
  });

  // Select all checkbox
  function toggleSelectAll(checkbox) {
    const checkboxes = document.querySelectorAll(".file-checkbox");
    checkboxes.forEach((cb) => {
      // Only select visible rows
      const row = cb.closest("tr");
      if (row.style.display !== "none") {
        cb.checked = checkbox.checked;
      }
    });
    updateDeleteButton();
  }

  // Update delete and download button states
  function updateDeleteButton() {
    const checkboxes = document.querySelectorAll(".file-checkbox:checked");
    const deleteBtn = document.getElementById("deleteSelectedBtn");
    const downloadBtn = document.getElementById("downloadSelectedBtn");

    const isDisabled = checkboxes.length === 0;
    deleteBtn.disabled = isDisabled;
    downloadBtn.disabled = isDisabled;

    if (checkboxes.length > 0) {
      deleteBtn.textContent = `üóëÔ∏è Delete Selected (${checkboxes.length})`;
      downloadBtn.textContent = `üì• Download Selected (${checkboxes.length})`;
    } else {
      deleteBtn.textContent = "üóëÔ∏è Delete Selected";
      downloadBtn.textContent = "üì• Download Selected";
    }
  }

  // Delete single item
  function deleteSingle(path, name) {
    const modal = document.getElementById("deleteModal");
    const message = document.getElementById("deleteMessage");
    const confirmBtn = document.getElementById("confirmDeleteBtn");

    message.textContent = `Are you sure you want to delete "${name}"? This action cannot be undone.`;
    modal.classList.remove("hidden");

    confirmBtn.onclick = function () {
      const form = document.createElement("form");
      form.method = "POST";
      form.action = "/delete";

      const input = document.createElement("input");
      input.type = "hidden";
      input.name = "path";
      input.value = path;

      form.appendChild(input);
      document.body.appendChild(form);
      form.submit();
    };
  }

  // Delete selected items
  function deleteSelected() {
    const checkboxes = document.querySelectorAll(".file-checkbox:checked");
    if (checkboxes.length === 0) return;

    const modal = document.getElementById("deleteModal");
    const message = document.getElementById("deleteMessage");
    const confirmBtn = document.getElementById("confirmDeleteBtn");

    message.textContent = `Are you sure you want to delete ${checkboxes.length} item(s)? This action cannot be undone.`;
    modal.classList.remove("hidden");

    confirmBtn.onclick = function () {
      document.getElementById("deleteForm").submit();
    };
  }

  // Download selected items
  function downloadSelected() {
    const checkboxes = document.querySelectorAll(".file-checkbox:checked");
    if (checkboxes.length === 0) return;

    // Create a form to submit the download request
    const form = document.createElement("form");
    form.method = "POST";
    form.action = "/download-multiple";

    // Add each selected file as a form input
    checkboxes.forEach((checkbox) => {
      const input = document.createElement("input");
      input.type = "hidden";
      input.name = "selected_files";
      input.value = checkbox.value;
      form.appendChild(input);
    });

    document.body.appendChild(form);
    form.submit();
    document.body.removeChild(form);
  }

  // Close modal
  function closeModal() {
    document.getElementById("deleteModal").classList.add("hidden");
  }

  // Close modal on outside click
  window.onclick = function (event) {
    const modal = document.getElementById("deleteModal");
    if (event.target === modal) {
      closeModal();
    }
  };
</script>
{% endblock %}
